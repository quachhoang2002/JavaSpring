<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta
            name="description"
            content=""
    />
    <meta
            name="author"
            content=""
    />
    <title>Shop Homepage - Start Bootstrap Template</title>
    <!-- Favicon -->
    <link
            rel="icon"
            type="image/x-icon"
            href="assets/favicon.ico"
    />
    <!-- Bootstrap icons -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
            rel="stylesheet"
    />
    <!-- Core theme CSS (includes Bootstrap) -->
    <link
            href="css/home.css"
            rel="stylesheet"
    />
    <style>
        .slider {
            -webkit-appearance: none;
            width: 15%;
            height: 10px;
            background: #d3d3d3;
            border-radius: 10px;
            outline: none;
            opacity: 0.7;
            -webkit-transition: 0.2s;
            transition: opacity 0.2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #212529;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: #04aa6d;
            cursor: pointer;
        }

        .filter-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-container select {
            width: 5%;
            border: none;
        }

        .active-page-button {
            background-color: #000; /* Màu nền nút khi được chọn */
            color: #fff; /* Màu văn bản khi được chọn */
        }

        #cart-form button a {
            text-decoration: none;
            color: black;
            position: relative;
            width: 100%;
            height: 100%;
            padding: 10px;
        }

        #cart-form button a:hover {
            color: white;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container px-4 px-lg-5">
        <a
                class="navbar-brand"
                href="#!"
        >Start Bootstrap</a
        >
        <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent"
                aria-expanded="false"
                aria-label="Toggle navigation"
        >
            <span class="navbar-toggler-icon"></span>
        </button>
        <div
                class="collapse navbar-collapse"
                id="navbarSupportedContent"
        >
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                <li class="nav-item">
                    <a
                            class="nav-link active"
                            aria-current="page"
                            href="#!"
                    >Home</a
                    >
                </li>
                <li class="nav-item">
                    <a
                            class="nav-link"
                            href="#!"
                    >About</a
                    >
                </li>
                <li class="nav-item dropdown">
                    <a
                            class="nav-link dropdown-toggle"
                            id="navbarDropdown"
                            href="#"
                            role="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                    >Shop</a
                    >
                    <ul
                            class="dropdown-menu"
                            aria-labelledby="navbarDropdown"
                    >
                        <li>
                            <a
                                    class="dropdown-item"
                                    href="#!"
                            >All Products</a
                            >
                        </li>
                        <li>
                            <hr class="dropdown-divider" />
                        </li>
                        <li>
                            <a
                                    class="dropdown-item"
                                    href="#!"
                            >Popular Items</a
                            >
                        </li>
                        <li>
                            <a
                                    class="dropdown-item"
                                    href="#!"
                            >New Arrivals</a
                            >
                        </li>
                    </ul>
                </li>
            </ul>
            <form
                    id="cart-form"
                    class="d-flex"
            >
                <button
                        id="logout-btn"
                        class="btn btn-person-dash-fill"
                        type="submit"
                        style="display: none"
                >
                    <i class="bi-person-fill me-1"></i>
                    Log out
                </button>
                <button
                        id="cart-btn"
                        class="btn btn-outline-dark"
                        type="submit"
                        style="display: none"
                >
                    <i class="bi-cart-fill me-1"></i>
                    Cart
                    <span
                            class="badge bg-dark text-white ms-1 rounded-pill"
                    >0</span
                    >
                </button>
                <button
                        id="login-btn"
                        class="btn btn-outline-dark"
                        type="submit"
                >
                    <a href="/login">
                        <i class="bi-person-fill me-1"></i>
                        Sign in
                    </a>
                </button>
            </form>
        </div>
    </div>
</nav>
<!-- Header -->
<header class="bg-dark py-5">
    <div class="container px-4 px-lg-5 my-5">
        <div class="text-center text-white">
            <h1 class="display-4 fw-bolder">Shop in style</h1>
            <p class="lead fw-normal text-white-50 mb-0">
                With this shop homepage template
            </p>
        </div>
    </div>
</header>
<!-- Section -->
<section
        class="h-100 h-custom"
        style="background-color: #eee"
>
    <div class="container h-100 py-5">
        <div
                class="row d-flex justify-content-center align-items-center h-100"
        >
            <div class="col">
                <div
                        class="card shopping-cart"
                        style="border-radius: 15px"
                >
                    <div class="card-body text-black">
                        <div class="row">
                            <div
                                    class="col-lg-6 px-5 py-4"
                                    id="content-container"
                            >
                                <h3
                                        class="mb-5 pt-2 text-center fw-bold text-uppercase"
                                >
                                    Your products
                                </h3>

                                <hr
                                        class="mb-4"
                                        style="
                                                height: 2px;
                                                background-color: #1266f1;
                                                opacity: 1;
                                            "
                                />

                                <!--                                <div-->
                                <!--                                        class="d-flex justify-content-between px-x"-->
                                <!--                                >-->
                                <!--                                    <p class="fw-bold">Discount:</p>-->
                                <!--                                    <p class="fw-bold">95$</p>-->
                                <!--                                </div>-->
                                <!--                                <div-->
                                <!--                                        class="d-flex justify-content-between p-2 mb-2"-->
                                <!--                                        style="background-color: #e1f5fe"-->
                                <!--                                >-->
                                <!--                                    <h5 class="fw-bold mb-0">Total:</h5>-->
                                <!--                                    <h5 class="fw-bold mb-0">2261$</h5>-->
                                <!--                                </div>-->
                            </div>
                            <div class="col-lg-6 px-5 py-4">
                                <h3
                                        class="mb-5 pt-2 text-center fw-bold text-uppercase"
                                >
                                    Payment
                                </h3>

                                <form class="mb-5">
                                    <label
                                            class="form-label"
                                            for="typeFullName"
                                    >Họ tên</label
                                    >
                                    <div class="form-outline mb-5">
                                        <input
                                                type="text"
                                                id="typeFullName"
                                                class="form-control form-control-lg"
                                                siez="17"
                                                minlength="19"
                                                maxlength="19"
                                                placeholder=""
                                        />

                                    </div>

                                    <div class="form-outline mb-5">
                                        <label
                                                class="form-label"
                                                for="typeAddress"
                                        >Địa chỉ giao hàng</label
                                        >
                                        <input
                                                type="text"
                                                id="typeAddress"
                                                class="form-control form-control-lg"
                                                siez="17"
                                        />

                                    </div>
                                    <div class="form-outline mb-5">
                                        <label
                                                class="form-label"
                                                for="typePhone"
                                        >Số điện thoại</label
                                        >
                                        <input
                                                type="text"
                                                id="typePhone"
                                                class="form-control form-control-lg"
                                                siez="17"
                                                placeholder="+84..."

                                        />

                                    </div>

                                    <!-- <div class="row">
                                        <div class="col-md-6 mb-5">
                                            <div class="form-outline">
                                                <input
                                                    type="text"
                                                    id="typeExp"
                                                    class="form-control form-control-lg"
                                                    value="01/22"
                                                    size="7"
                                                    minlength="7"
                                                    maxlength="7"
                                                />
                                                <label
                                                    class="form-label"
                                                    for="typeExp"
                                                    >Expiration</label
                                                >
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-5">
                                            <div class="form-outline">
                                                <input
                                                    type="password"
                                                    id="typeText2"
                                                    class="form-control form-control-lg"
                                                    value="&#9679;&#9679;&#9679;"
                                                    size="1"
                                                    minlength="3"
                                                    maxlength="3"
                                                />
                                                <label
                                                    class="form-label"
                                                    for="typeText"
                                                    >Cvv</label
                                                >
                                            </div>
                                        </div>
                                    </div> -->

                                    <p class="mb-5">
                                        <a href="#!"></a>
                                    </p>

                                    <button
                                            type="button"
                                            class="btn btn-primary btn-block btn-lg"
                                            id="buy-now"
                                    >
                                        Buy now
                                    </button>

                                    <h5
                                            class="fw-bold mb-5"
                                            style="
                                                    position: absolute;
                                                    bottom: 0;
                                                "
                                    >
                                        <a href="/"
                                        ><i
                                                class="fas fa-angle-left me-2"
                                        ></i
                                        >Back to shopping</a
                                        >
                                    </h5>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Footer -->
<footer class="py-5 bg-dark">
    <div class="container">
        <p class="m-0 text-center text-white">
            Copyright &copy; Your Website 2023
        </p>
    </div>
</footer>
<!-- Bootstrap core JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core theme JS -->
<script src="js/scripts.js"></script>
<script
        type="text/javascript"
        src="https://code.jquery.com/jquery-1.7.1.min.js"
></script>
<script>
    window.onload = function () {
        renderProductItems();
    };

    async function renderProductItems() {
        const url = 'http://localhost:8081/api/cart/getAll';

        try {
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();

                const container =
                    document.querySelector('#content-container');
                if (
                    !data.productItems ||
                    data.productItems.length === 0
                ) {
                    console.log(data);
                    container.innerHTML =
                        "You haven't added any items to your cart.";
                } else {
                    console.log(data);

                    data.productItems.forEach((item, index) => {
                        const productItem =
                            document.createElement('div');
                        productItem.classList.add(
                            'd-flex',
                            'align-items-center',
                            'mb-5'
                        );

                        const productImage =
                            document.createElement('div');
                        productImage.classList.add('flex-shrink-0');
                        productImage.innerHTML = `<img src="${item.imagePath}" class="img-fluid" style="width: 150px;" alt="Product Image">`;

                        const productDetails =
                            document.createElement('div');
                        productDetails.classList.add(
                            'flex-grow-1',
                            'ms-3'
                        );

                        const closeIcon = document.createElement('a');
                        closeIcon.href = '#!';
                        closeIcon.classList.add(
                            'float-end',
                            'text-black'
                        );
                        closeIcon.innerHTML = `<i class="fas fa-times"></i>`;

                        const productName =
                            document.createElement('h5');
                        productName.classList.add('text-primary');
                        productName.innerText = item.name;

                        const productColor =
                            document.createElement('h6');
                        productColor.style.color = '#9e9e9e';
                        productColor.innerText = `Tên sản phẩm: ${item.name}`;

                        const priceAndQuantity =
                            document.createElement('div');
                        priceAndQuantity.classList.add(
                            'd-flex',
                            'align-items-center'
                        );

                        const productPrice =
                            document.createElement('p');
                        productPrice.classList.add(
                            'fw-bold',
                            'mb-0',
                            'me-5',
                            'pe-3'
                        );
                        const formattedPrice = formatPrice(item.price);
                        productPrice.innerText = `${formattedPrice} VNĐ`;

                        const quantityInput =
                            document.createElement('div');
                        quantityInput.classList.add(
                            'def-number-input',
                            'number-input',
                            'safari_only'
                        );
                        quantityInput.style.display = 'flex';

                        const quantityField =
                            document.createElement('input');
                        quantityField.classList.add(
                            'quantity',
                            'fw-bold',
                            'text-black'
                        );
                        quantityField.type = 'number';
                        quantityField.min = '0';
                        quantityField.name =
                            data.cartItems[index].productId;
                        quantityField.value =
                            data.cartItems[index].quantity;
                        quantityInput.appendChild(quantityField);

                        quantityField.setAttribute('data-index', index);
                        quantityField.onchange = function () {
                            // Lấy index từ thuộc tính data-index
                            const itemIndex =
                                this.getAttribute('data-index');
                            const newQuantity = parseInt(this.value);
                            if (
                                !isNaN(newQuantity) &&
                                newQuantity >= 0
                            ) {
                                const updateData = {
                                    id: data.cartItems[index].productId, // Thêm id vào dữ liệu cần gửi
                                    quantity: newQuantity,
                                };
                                updateQuantity(updateData);
                            } else {
                                // Khôi phục lại giá trị trước đó nếu người dùng nhập giá trị không hợp lệ
                                quantityField.value =
                                    data.cartItems[index].quantity;
                            }
                        };

                        productDetails.appendChild(closeIcon);
                        productDetails.appendChild(productName);
                        productDetails.appendChild(productColor);
                        productDetails.appendChild(priceAndQuantity);
                        priceAndQuantity.appendChild(productPrice);
                        priceAndQuantity.appendChild(quantityInput);

                        productItem.appendChild(productImage);
                        productItem.appendChild(productDetails);

                        container.appendChild(productItem);
                    });

                    // Calculate and display the total price
                    const totalContainer =
                        document.createElement('div');
                    totalContainer.classList.add(
                        'd-flex',
                        'justify-content-between',
                        'p-2',
                        'mb-2'
                    );
                    totalContainer.style.backgroundColor = '#e1f5fe';
                    const totalLabel = document.createElement('h5');
                    totalLabel.classList.add('fw-bold', 'mb-0');
                    totalLabel.innerText = 'Total:';
                    const totalPrice = data.productItems.reduce(
                        (total, item, index) => {
                            return (
                                total +
                                item.price *
                                    data.cartItems[index].quantity
                            );
                        },
                        0
                    );
                    const formattedTotal = formatPrice(totalPrice);
                    const totalValue = document.createElement('h5');
                    totalValue.classList.add('fw-bold', 'mb-0');
                    totalValue.innerText = formattedTotal + ' VNĐ';
                    totalValue.id = 'total-value';

                    totalContainer.appendChild(totalLabel);
                    totalContainer.appendChild(totalValue);
                    container.appendChild(totalContainer);
                }
            } else {
                console.error('Failed to fetch product items.');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
        }).format(price);
    }
    function updateQuantity(data) {
        const updateUrl = `http://localhost:8081/api/cart/updateQuantity`;

        fetch(updateUrl, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data), // Truyền dữ liệu vào đây
        })
            .then((response) => response.json())
            .then((response) => {
                // Xử lý kết quả trả về từ controller
                console.log('Update response:', response);
                if (response.status === 'success') {
                    // Nếu cập nhật thành công, cập nhật lại total price
                    calculateTotalPrice();
                } else {
                    // Hiển thị thông báo lỗi nếu cập nhật không thành công
                    console.error('Update error:', response.message);
                }
            })
            .catch((error) => {
                console.error('Update error:', error);
            });
    }

    function calculateTotalPrice() {
        const url = 'http://localhost:8081/api/cart/getAll';

        fetch(url)
            .then((response) => response.json())
            .then((data) => {
                if (data && data.productItems && data.cartItems) {
                    const totalPrice = data.productItems.reduce(
                        (total, item, index) => {
                            return (
                                total +
                                item.price *
                                    data.cartItems[index].quantity
                            );
                        },
                        0
                    );

                    // Định dạng total price
                    const formattedTotal = formatPrice(totalPrice);

                    // Cập nhật total price trong HTML
                    const totalValueElement =
                        document.querySelector('#total-value');
                    totalValueElement.innerText =
                        formattedTotal + ' VNĐ';
                }
            })
            .catch((error) => {
                console.error(
                    'Failed to calculate total price:',
                    error
                );
            });
    }
</script>
</body>
</html>
